name: Build python-rtmidi Wheels

on:
  workflow_dispatch: # Allows manual trigger

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Build for Linux, Windows, and macOS
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout python-rtmidi (recursive)
        # We must use 'recursive' to get the rtmidi C++ submodule
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@v5

      - name: Install cibuildwheel
        run: pip install cibuildwheel

      - name: Build wheels
        run: cibuildwheel --output-dir wheelhouse
        env:
          # For Linux: Install ALSA dev libraries inside the build container
          CIBW_BEFORE_ALL_LINUX: "apt-get update && apt-get install -y libasound2-dev"
          
          # For macOS: Ensure the correct SDK is found
          CIBW_ENVIRONMENT_MACOS: SDKROOT=macosx

      - name: Upload wheels as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl